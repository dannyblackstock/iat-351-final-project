<!doctype html>
<html>
  <head>
    <title>Socket.IO chat</title>
    <style>
      body {
        font-family: sans-serif;
        font-size: 16px;
        color: white;
      }
      img {
        z-index:-8;
        position: fixed; 
        top: 0; 
        left: 0; 
        height: 100%; 
        width: 100%; 
      }

    </style>
  </head>
  <body>
    <img id="gradient-map" src="gradient-map.png">

    <div>Fingers: <span id="fingerMsg"></span></div>
    
    <!-- <form action="">
      <input id="m" autocomplete="off" /><button>Send</button>
    </form> -->
    <div id="rgbMsg"></div>

    <script src="https://cdn.socket.io/socket.io-1.2.0.js"></script>
    <script src="http://code.jquery.com/jquery-1.11.1.js"></script>
    <script>
      var socket = io();
      var pixels = [];
      
      $('form').submit(function() {
        socket.emit('rgbMsg', $('#m').val());
        $('#m').val('');
        return false;
      });
      socket.on('rgbMsg', function(msg) {
        $('#rgbMsg').text(RGBtoXY(msg));
      });

      $
      socket.on('fingerMsg', function(msg) {
        $('#fingerMsg').text(msg);
      })

      $(document).ready(function() {
        var canvas = document.createElement('canvas');
        canvas.width = 600;
        canvas.height = 600;
        var context = canvas.getContext('2d');
        var img = new Image();
        img.src = "gradient-map.png";
        context.drawImage(img, 0, 0);
        imgData = context.getImageData(0, 0, img.width, img.height);
        // console.log(imgData);
        
        var j = 0;    // pixel iterator
        var xi = 0;   // x iterator
        var yi = 0;   // y iterator
        for (var i = 3; i < imgData.data.length + 4; i+=4) {
          // get every pixel's rgba value [0]=R [1]=G [2]=B [3]=A
          // and set its position
          pixels[j] = {};
          pixels[j].r = imgData.data[i-3];
          pixels[j].g = imgData.data[i-2];
          pixels[j].b = imgData.data[i-1];
          pixels[j].a = imgData.data[i];
          pixels[j].x = img.width-xi;
          pixels[j].y = yi;

          xi++;       // go to next pixel
          if (xi > img.width) {
            yi++;     // go to next line
            xi = 0;   // reset to 0
          };
          
          j++;
        };
      });

      function RGBtoXY (msg) {
        msg = msg.substring(2);
        var color = hexToRgb(msg);
        // var color = msg.split(","); //.textContent.split(",");
        var x = -1;
        var y = -1;
        console.log(color.r+" "+color.g+" "+color.b);

        // map from rgb to x,y value
        for (var i = 0; i < pixels.length; i++) {
          if (pixels[i].r == color.r && pixels[i].g == color.g && pixels[i].b == color.b) {
            x = pixels[i].x;
            y = pixels[i].y;
          };
        };
        return x + "," + y;
      }

      // http://stackoverflow.com/questions/5623838/rgb-to-hex-and-hex-to-rgb
      function hexToRgb(hex) {
        var result = /^#?([a-f\d]{2})([a-f\d]{2})([a-f\d]{2})$/i.exec(hex);
        return result ? {
          r: parseInt(result[1], 16),
          g: parseInt(result[2], 16),
          b: parseInt(result[3], 16)
        } : null;
      }
    </script>
  </body>
</html>