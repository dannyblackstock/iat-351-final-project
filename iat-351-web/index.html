<!doctype html>
<html>
  <head>
    <title>Socket.IO chat</title>
    <style>
      /*#gradient-map {
        z-index: -10;
        position: absolute;
        top: 0;
        left: 0;
          width: 100%;
          height: 100%;
        background: linear-gradient(45deg, #0F0, #F00);
      }

      #gradient-map:after {
        z-index: -9;
        position: absolute;
        top: 0;
        left: 0;
        width: 100%;
          height: 100%;
          content: "";
        background: linear-gradient(135deg, #00F, #F00);
        -webkit-mask: linear-gradient(white, transparent);
        mask: linear-gradient(white, transparent);
      }*/

      img {
        z-index:-8;
        position: fixed; 
        top: 0; 
        left: 0; 
        height: 100%; 
        width: 100%; 
      }
    </style>
  </head>
  <body>
    <!-- <div id="gradient-map"></div> -->
    <img id="gradient-map" src="gradient-map.png">
    <form action="">
      <input id="m" autocomplete="off" /><button>Send</button>
    </form>
    <ul id="messages"></ul>

    <script src="https://cdn.socket.io/socket.io-1.2.0.js"></script>
    <script src="http://code.jquery.com/jquery-1.11.1.js"></script>
    <script>
        var pixels = [];
      var socket = io();
      
      $('form').submit(function() {
        socket.emit('rgb message', $('#m').val());
        $('#m').val('');
        return false;
      });
      socket.on('rgb message', function(msg) {
        $('#messages').append($('<li>').text(RGBtoXY(msg)));
      });

      $(document).ready(function() {
        var canvas = document.createElement('canvas');
        canvas.width = 600;
        canvas.height = 600;
        var context = canvas.getContext('2d');
        var img = new Image();
        img.src = "gradient-map.png";
        context.drawImage(img, 0, 0);
        imgData = context.getImageData(0, 0, img.width, img.height);
        // console.log(imgData);
        
        var j = 0;    // pixel iterator
        var xi = 0;   // x iterator
        var yi = 0;   // y iterator
        for (var i = 3; i < imgData.data.length + 4; i+=4) {
          // get every pixel's rgba value [0]=R [1]=G [2]=B [3]=A
          // and set its position
          pixels[j] = {};
          pixels[j].r = imgData.data[i-3];
          pixels[j].g = imgData.data[i-2];
          pixels[j].b = imgData.data[i-1];
          pixels[j].a = imgData.data[i];
          pixels[j].x = img.width-xi;
          pixels[j].y = yi;

          xi++;       // go to next pixel
          if (xi > img.width) {
            yi++;     // go to next line
            xi = 0;   // reset to 0
          };
          
          j++;
        };
      });

      // android RGB -> compy RGB -> 
      // for every pixel
      // pixel.color = asdf
      // pixel.x/y = 1234

      // for every pixel in pixels
      // if pixel.color = incomingmessage.color
      //   output.x = pixel.x
      //   "x/y" = that color's pixel x/y
      // emit "x/y"
      // -> compy pixel location -> return location to android

      Number.prototype.map=function(a,b,c,d){return c+(d-c)*((this-a)/(b-a))};

      function RGBtoXY (msg) {
        var color = msg.split(","); //.textContent.split(",");
        var r = color[0];
        var g = color[1];
        var b = color[2];
        var x = -1;
        var y = -1;
        console.log(r+" "+g+" "+b);

        // map from rgb to x,y value
        for (var i = 0; i < pixels.length; i++) {
          if (pixels[i].r == r && pixels[i].g == g && pixels[i].b == b) {
            // if (pixels[i].g == g) {
              // if (pixels[i].b == b) {
                x = pixels[i].x;
                y = pixels[i].y;
              // }
            // }
          };
        };
        return x + "," + y;
      }
    </script>
  </body>
</html>